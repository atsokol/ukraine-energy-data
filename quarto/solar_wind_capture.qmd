---
title: "RES Price Capture in Ukraine and Neighboring EU Countries"
format: html
editor: visual
execute:
  echo: false
  warning: false
  message: false
---

```{r}
library(readr)
library(dplyr)
library(lubridate)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)
library(here)
library(httr)
library(glue)

source(here("src/helper_func_EU.R"))


# Combine EU generation and price data 
gen_eu <- read_csv(here("data/data_raw/yield_RES_EU.csv"))
price_eu <- read_csv(here("data/data_raw/DAM_EU.csv"))
load_eu <- read_csv(here("data/data_raw/load_EU.csv"))


data_eu <- gen_eu |>
  left_join(price_eu, by = c("country", "hour")) |> 
  left_join(load_eu, by = c("country", "hour"))

# Combine UA generation and price data
price_ua <- read_csv(here("data/data_raw/DAM_UA.csv"))

gen_ua <- rbind(
    read_csv(here("data/data_raw/yield_solar_UA.csv")) |> mutate(type = "Solar"),
    read_csv(here("data/data_raw/yield_wind_UA.csv")) |> mutate(type = "Wind onshore")
) |> 
    transmute(
        hour = ymd_h(paste(format(date, "%Y-%m-%d"), hour - 1), tz = "UTC"),
        type = type,
        gen_mw = if_else(actual < 0, 0, actual)
        )

data_ua <- left_join(
    price_ua,
    gen_ua,
    by = c("hour" = "hour")
) |> 
    rename(
        tech = type
    ) |> 
    filter(
        !is.na(gen_mw)
    ) |> 
    mutate(date = as_date(hour)) |> 
    select(
        country,
        hour,
        tech,
        gen_mw,
        price_eur = price_eur_mwh,
        volume
    )

data_all <- rbind(data_eu, data_ua)
# write_csv(data_all, "data/data_output/data_eu_ua.csv")

```

## Capacity factors

```{r}
# Calculate capacity factors for each generation type
# # monthly median of daily values

factor_d <- data_all |>
  mutate(date = floor_date(hour, unit = "days")) |>
  group_by(country, tech, date) |>
  summarise(
    price_res = sum(price_eur * gen_mw, na.rm = TRUE) / sum(gen_mw, na.rm = TRUE),
    price_base = mean(price_eur, na.rm = TRUE),
    cap_factor = price_res / price_base,
    .groups = "drop") 

factor_m <- factor_d |> 
  group_by(country, tech, date = floor_date(date, unit = "months")) |> 
  summarise(
    cap_factor = median(cap_factor, na.rm = TRUE),
    .groups = "drop"
  ) 

ggplot(factor_m, aes(x = date, y = cap_factor, color = tech)) +
  geom_point(alpha = 0.3) +
  geom_smooth(se=FALSE) +
  facet_wrap(~country) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Solar and Wind Capture Factors",
    x = "",
    y = "",
    color = ""
  ) +
  theme_minimal()

# ggplot(factor_d |> filter(country == "UA"), 
#     aes(x = date, y = cap_factor, color = tech)) +
#   geom_point(alpha = 0.3) +
#   geom_smooth(se=FALSE) +
#   facet_wrap(~country) +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#   labs(
#     title = "Solar and Wind Capture Factors",
#     x = "",
#     y = "",
#     color = ""
#   ) +
#   theme_minimal()


# Seasonal variation of capture factors
factor_seas <- factor_m |> 
  mutate(
    month = month(date, label = TRUE),
    year = year(date) |> as.factor()
  )

ggplot(factor_seas, aes(x = month, y = cap_factor, color = year, group = year)) +
    geom_point(alpha = 0.3) +
    geom_smooth(se=FALSE) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    facet_grid(tech ~ country) +
    scale_x_discrete(breaks = levels(factor_seas$month)[seq(1, 12, by = 3)]) +
    labs(
        title = "Solar and Wind Capture Factors by Year",
        x = "",
        y = "Capture Factor",
        color = "Year"
    ) +
    theme_minimal()

```

## Basic charts

```{r}

price_base <- data_all |>
  mutate(date = floor_date(hour, unit = "days")) |>
  group_by(country, date) |>
  summarise(
    price = mean(price_eur, na.rm = TRUE), 
    .groups = "drop"
  )

g5 <- ggplot(price_base, aes(x = date, y = price, colour = country)) +
  geom_point(alpha = 0.1) +
  geom_smooth(span = 0.2, se=FALSE) +
  labs(
    title = "Day-Ahead Baseload Electricity Prices",
    x = "",
    y = "EUR/MWh"
  ) +
  theme_minimal()

ggplotly(g5)
```

```{r}

ggplot(
  data_all |> 
    filter(country == "UA") |> 
    group_by(year = factor(year(hour))) |>
    mutate(
      gen_ann = mean(gen_mw, na.rm = TRUE)
    ) |> 
    group_by(hour = hour(hour), year, .add = TRUE) |> 
    summarise(
      gen_mw = mean(gen_mw, na.rm = TRUE) / first(gen_ann),
      .groups = "drop"
    ),
  aes(x = hour, y = gen_mw, color = year)
) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    se = FALSE
  ) +
  labs(
    title = "Median hourly generation, Ukraine 2025",
    x = "",
    y = "",
    color = ""
  ) +
  theme_minimal()

```

```{r}
bm_data <- read_csv(here("data/data_raw/BM_UA.csv"))

data_h <- bm_data |> 
  mutate(hour_dt = ymd_h(paste(format(date, "%Y-%m-%d"), hour), tz = "UTC")) |>
  select(hour_dt, direction, volume_bm, price_bm_uah, price_dam_uah, volume_dam) |>
  pivot_wider(
    names_from = direction,
    values_from = c(volume_bm, price_bm_uah),
    names_glue = "{.value}_{tolower(direction)}"
  ) |>
  mutate(
    spread_up = price_bm_uah_up - price_dam_uah,
    spread_down = price_dam_uah - price_bm_uah_down,
    volume_up = volume_bm_up,
    volume_down = volume_bm_down
  ) 

data_h |>
  pivot_longer(
    cols = matches("_(up|down)$"),
    names_to = c(".value", "side"),
    names_pattern = "(.*)_(up|down)$"
  ) |>
  mutate(side = factor(side)) |>
  group_by(year = factor(year(hour_dt)), hour = hour(hour_dt), side) |>
  summarise(
    spread = median(spread, na.rm = TRUE),
    volume = median(volume, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = c(spread, volume),
    names_to = "type",
    values_to = "value"
  ) |>
  ggplot(aes(x = hour, y = value, color = year)) +
    geom_smooth(
      method = "gam",
      formula = y ~ s(x, bs = "cs"),
      se = FALSE
    ) +
    facet_grid(cols = vars(side), rows = vars(type), scales = "free_y") +
    labs(
      title = "Intraday Price Spreads vs Day-Ahead Market",
      x = "",
      y = "Spread (UAH/MWh)"
    ) +
    theme_minimal()

data_d <- data_h |> 
  group_by(date = as_date(hour_dt)) |>
  summarise(
    spread_up = sum(pmax(spread_up, 0) * volume_up, na.rm = TRUE) / sum(volume_up, na.rm = TRUE),
    spread_down = sum(pmax(spread_down, 0) * volume_down, na.rm = TRUE) / sum(volume_down, na.rm = TRUE),
    spread_tot = spread_up + spread_down,
    volume_up = sum(volume_up, na.rm = TRUE) / 24,
    volume_down = sum(volume_down, na.rm = TRUE) / 24,
    volume_tot = volume_up + volume_down,
    .groups = "drop"
  ) |> 
  pivot_longer(
    cols = matches("_(up|down|tot)$"),
    names_to = c(".value", "type"),
    names_pattern = "(.*)_(up|down|tot)$"
  ) |> 
  mutate(type = factor(type))

ggplot(data_d, aes(x = date)) +
  geom_point(aes(y = spread, color = type), alpha = 0.1) +
  geom_smooth(aes(y = spread, color = type), se=FALSE) +
  facet_grid(col = vars(type)) +
  theme_minimal()


ggplot(data_d, aes(x = date)) +
  geom_point(aes(y = volume, color = type), alpha = 0.1) +
  geom_smooth(aes(y = volume, color = type), se=FALSE) +
  facet_grid(col = vars(type)) +
  theme_minimal()

```

## Balancing market

```{r}
price_bm_eu <- read_csv(here("data/data_raw/BM_EU.csv"))
price_eu <- read_csv(here("data/data_raw/DAM_EU.csv"))

price_bm_hourly <- price_bm_eu |> 
  group_by(country, direction, reserve_type, currency, hour = floor_date(datetime, unit = "hours")) |> 
  summarise(
    price = mean(price[price != 0], na.rm = TRUE),
    .groups = "drop"
  ) |> 
  convert_to_eur(date_col = "hour") |> 
  filter(!is.na(price) & !is.nan(price)) |> 
  rename(price_bm_eur = price_eur) |> 
  left_join(
    price_eu |> mutate(country = case_when(
      country == "SK" ~ "Slovak Republic",
      country == "HU" ~ "Hungary",
      country == "PL" ~ "Poland",
      country == "RO" ~ "Romania"
    )),
    by = c("country", "hour")) |> 
  rename(price_dam_eur = price_eur) |> 
  arrange(country, hour, direction) |> 
  mutate(
    spread = ifelse(direction == "UP", price_bm_eur - price_dam_eur, price_dam_eur - price_bm_eur)
  ) 

  price_bm_daily <- price_bm_hourly |>
    group_by(country, direction, reserve_type, date = as_date(hour)) |>
    summarise(
      spread = mean(spread, na.rm = TRUE),
      .groups = "drop"
    ) |> 
    mutate(direction = factor(direction),
          reserve_type = factor(reserve_type)
          ) |> 
    arrange(country, date, direction)

ggplot(price_bm_daily |> filter(reserve_type == "Manual frequency restoration reserve"), 
  aes(x = date, y = spread, color = reserve_type)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  facet_grid(rows = vars(country), cols = vars(direction)) +
  scale_y_continuous(limits = c(0, 1000)) +
  theme_minimal()

```

## Cross-border flows

```{r}
sched_capacity <- read_csv(here("data/data_raw/transm_sched_EU.csv")) |> 
  mutate(direction = ifelse(from_country == "UA", "export", "import"),
    country = ifelse(direction == "export", to_country, from_country)) |> 
  select(direction, country, hour, flow = scheduled_mw)

flows <- read_csv(here("data/data_raw/transm_phys_EU.csv")) |> 
  mutate(direction = ifelse(from_country == "UA", "export", "import"),
    country = ifelse(direction == "export", to_country, from_country)) |> 
  select(direction, country, hour, flow = physical_flow_mw)

# Flows
flows_m <- flows |> 
  group_by(direction, country, date = floor_date(hour, unit = "months")) |>
  summarise(
    flow = sum(flow, na.rm = TRUE),
    .groups = "drop"
  )

flows_m_net <- flows_m |>  
  pivot_wider(
    names_from = direction,
    values_from = flow
  ) |> 
  mutate(net = export - import)

ggplot() +
    geom_col(
      data =  flows_m,
      aes(x = date, y = ifelse(direction == "export", flow, -flow), fill = country),
      stat = "identity", alpha = 0.7, color = NA) +
    geom_line(
      data = flows_m_net,
      aes(x = date, y = net),
      color = "black", size = 0.5) +
    geom_hline(yintercept = 0, color = "grey40") +
    facet_grid(cols = vars(country)) +
    labs(title = "Cross-border flows") +
    theme_minimal()

flows_m_tot <- flows_m |> 
  group_by(direction, date) |>
  summarise(
    flow = sum(flow, na.rm = TRUE),
    .groups = "drop"
  ) 

flows_m_net <- flows_m_tot |> 
  pivot_wider(
    names_from = direction,
    values_from = flow
  ) |> 
  mutate(net = export - import)

ggplot() +
  geom_col(data = flows_m_tot,
    aes(x = date, y = ifelse(direction == "export", flow, -flow), fill = direction),
    stat = "identity", alpha = 0.7, color = NA) +
  geom_line(data = flows_m_net, aes(x = date, y = net), color = "black", size = 0.5) +
  geom_hline(yintercept = 0, color = "grey40") +
  labs(title = "Cross-border flows") +
  theme_minimal()

# Scheduled capacity
sched_cap_m <- sched_capacity |> 
  group_by(direction, country, date = floor_date(hour, unit = "months")) |>
  summarise(
    flow = sum(flow, na.rm = TRUE),
    .groups = "drop"
  ) 

sched_cap_m_net <- sched_cap_m |>
    pivot_wider(
      names_from = direction,
      values_from = flow
    ) |> 
    mutate(net = export - import)

ggplot() +
    geom_col(
      data =  sched_cap_m,
      aes(x = date, y = ifelse(direction == "export", flow, -flow), fill = country),
      stat = "identity", alpha = 0.7, color = NA) +
    geom_line(
      data = sched_cap_m_net,
      aes(x = date, y = net),
      color = "black", size = 0.5) +
    geom_hline(yintercept = 0, color = "grey40") +
    facet_grid(cols = vars(country)) +
    labs(title = "Scheduled Capacity") +
    theme_minimal()

sched_cap_m_tot <- sched_cap_m |> 
  group_by(direction, date) |>
  summarise(
    flow = sum(flow, na.rm = TRUE),
    .groups = "drop"
  ) 

sched_cap_m_net <- sched_cap_m_tot |> 
  pivot_wider(
    names_from = direction,
    values_from = flow
  ) |> 
  mutate(net = export - import)

ggplot() +
  geom_col(data = sched_cap_m_tot, 
    aes(x = date, y = ifelse(direction == "export", flow, -flow), fill = direction),
    stat = "identity", alpha = 0.7, color = NA) +
  geom_line(data = sched_cap_m_net, aes(x = date, y = net), color = "black", size = 0.5) +
  geom_hline(yintercept = 0, color = "grey40") +
  labs(title = "Scheduled Capacity") +
  theme_minimal()

sched_capacity |> 
  mutate(
    datetime = hour,
    year = year(hour),
    hour = hour(datetime)
  ) |>
  group_by(year, country, direction, hour) |>
  summarise(
    flow = mean(flow, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(year >= 2024) |> 
  ggplot(aes(x = hour, y = flow, color = factor(year))) +
    geom_line() +
    facet_grid(rows = vars(direction), cols = vars(country)) +
    labs(
      title = "Average Scheduled Capacity by Hour",
      x = "Hour of Day",
      y = "Scheduled Capacity (MW)",
      color = "Year"
    ) +
    theme_minimal()
```

## DAM spreads and cross-border flows

```{r}
# DAM spreads between Ukraine and EU markets
spreads_dam <- rbind(
  price_eu,
  price_ua |> select(country, hour, price_eur = price_eur_mwh) |> mutate(hour = hour - hours(1))
) |> 
  arrange(hour, country) |> 
  pivot_wider(
    names_from = country,
    values_from = price_eur
  ) |> 
  mutate(
    across(
      -c(hour, UA),
      ~ UA - .,
      .names = "spread_{.col}"
    )
  ) |> 
  select(hour, starts_with("spread_")) |> 
  pivot_longer(
    cols = starts_with("spread_"),
    names_to = "country",
    names_prefix = "spread_",
    values_to = "spread"
  ) 

spread_daily <- sched_capacity |> 
  left_join(spreads_dam, by = c("hour" = "hour", "country" = "country")) |> 
  mutate(spread = ifelse(direction == "import", spread, -spread)) |> 
  group_by(country, direction, date = as_date(hour)) |>
  summarise(
    spread = sum(spread * flow, na.rm = TRUE) / sum(flow, na.rm = TRUE),
    flow = sum(flow, na.rm = TRUE),
    .groups = "drop"
  ) 

ggplot(
  spread_daily , 
  aes(x = date, y = spread, color = country)) +
  geom_point(alpha = 0.1) +
  geom_smooth(se=FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  facet_grid(cols = vars(country), rows = vars(direction)) +
  # scale_y_log10()+
  labs(
    title = "DAM Price Spreads Weighted by Scheduled Cross-Border Flows",
    x = "",
    y = "Spread (EUR/MWh)"
  ) +
  theme_minimal()

```