---
title: "RES Price Capture in Ukraine and Neighboring EU Countries"
format: html
editor: visual
execute:
  echo: false
  warning: false
  message: false
---

```{r}
library(readr)
library(dplyr)
library(lubridate)
library(tidyr)
library(purrr)
library(ggplot2)
library(plotly)
```

```{r}

# Combine EU generation and price data 
gen_eu <- read_csv("../data/data_raw/yield_RES_EU.csv")
price_eu <- read_csv("../data/data_raw/DAM_EU.csv")
load_eu <- read_csv("../data/data_raw/load_EU.csv")


data_eu <- gen_eu |>
  left_join(price_eu, by = c("country", "hour")) |> 
  left_join(load_eu, by = c("country", "hour"))

# Combine UA generation and price data
price_ua <- read_csv("../data/data_raw/DAM_UA.csv")

gen_ua <- rbind(
    read_csv("../data/data_raw/yield_solar_UA.csv") |> mutate(type = "Solar"),
    read_csv("../data/data_raw/yield_wind_UA.csv") |> mutate(type = "Wind onshore")
) |> 
    transmute(
        hour = ymd_h(paste(format(date, "%Y-%m-%d"), hour - 1), tz = "UTC"),
        type = type,
        gen_mw = if_else(actual < 0, 0, actual)
        )

data_ua <- left_join(
    price_ua,
    gen_ua,
    by = c("hour" = "hour")
) |> 
    rename(
        tech = type
    ) |> 
    filter(
        !is.na(gen_mw)
    ) |> 
    mutate(date = as_date(hour)) |> 
    select(
        country,
        hour,
        tech,
        gen_mw,
        price_eur = price_eur_mwh,
        volume
    )

data_all <- rbind(data_eu, data_ua)
# write_csv(data_all, "data/data_output/data_eu_ua.csv")

```

```{r}
# Calculate capacity factors for each generation type
# # monthly median of daily values

factor_d <- data_all |>
  mutate(date = floor_date(hour, unit = "days")) |>
  group_by(country, tech, date) |>
  summarise(
    price_res = sum(price_eur * gen_mw, na.rm = TRUE) / sum(gen_mw, na.rm = TRUE),
    price_base = mean(price_eur, na.rm = TRUE),
    cap_factor = price_res / price_base,
    .groups = "drop") 

factor_m <- factor_d |> 
  group_by(country, tech, date = floor_date(date, unit = "months")) |> 
  summarise(
    cap_factor = median(cap_factor, na.rm = TRUE),
    .groups = "drop"
  ) 

ggplot(factor_m, aes(x = date, y = cap_factor, color = tech)) +
  geom_point(alpha = 0.3) +
  geom_smooth(se=FALSE) +
  facet_wrap(~country) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Solar and Wind Capture Factors",
    x = "",
    y = "",
    color = ""
  ) +
  theme_minimal()

# ggplot(factor_d |> filter(country == "UA"), 
#     aes(x = date, y = cap_factor, color = tech)) +
#   geom_point(alpha = 0.3) +
#   geom_smooth(se=FALSE) +
#   facet_wrap(~country) +
#   scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
#   labs(
#     title = "Solar and Wind Capture Factors",
#     x = "",
#     y = "",
#     color = ""
#   ) +
#   theme_minimal()


# Seasonal variation of capture factors
factor_seas <- factor_m |> 
  mutate(
    month = month(date, label = TRUE),
    year = year(date) |> as.factor()
  )

ggplot(factor_seas, aes(x = month, y = cap_factor, color = year, group = year)) +
    geom_point(alpha = 0.3) +
    geom_smooth(se=FALSE) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "black") +
    facet_grid(tech ~ country) +
    scale_x_discrete(breaks = levels(factor_seas$month)[seq(1, 12, by = 3)]) +
    labs(
        title = "Solar and Wind Capture Factors by Year",
        x = "",
        y = "Capture Factor",
        color = "Year"
    ) +
    theme_minimal()

```

```{r}

price_base <- data_all |>
  mutate(date = floor_date(hour, unit = "days")) |>
  group_by(country, date) |>
  summarise(
    price = mean(price_eur, na.rm = TRUE), 
    .groups = "drop"
  )

g5 <- ggplot(price_base, aes(x = date, y = price, colour = country)) +
  geom_point(alpha = 0.1) +
  geom_smooth(span = 0.2, se=FALSE) +
  labs(
    title = "Day-Ahead Baseload Electricity Prices",
    x = "",
    y = "EUR/MWh"
  ) +
  theme_minimal()

ggplotly(g5)
```

```{r}

ggplot(
  data_all |> 
    filter(country == "UA") |> 
    group_by(year = factor(year(hour))) |>
    mutate(
      gen_ann = mean(gen_mw, na.rm = TRUE)
    ) |> 
    group_by(hour = hour(hour), year, .add = TRUE) |> 
    summarise(
      gen_mw = mean(gen_mw, na.rm = TRUE) / first(gen_ann),
      .groups = "drop"
    ),
  aes(x = hour, y = gen_mw, color = year)
) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_smooth(
    method = "gam",
    formula = y ~ s(x, bs = "cs"),
    se = FALSE
  ) +
  labs(
    title = "Median hourly generation, Ukraine 2025",
    x = "",
    y = "",
    color = ""
  ) +
  theme_minimal()

```

```{r}
price_dam <- read_csv("/Users/andrii/Documents/R files/_My projects/RES data download/data/data_raw/DAM_UA.csv")
bm_data <- read_csv("/Users/andrii/Documents/R files/_My projects/RES data download/data/data_raw/BM_UA.csv")

data_h <- bm_data |> 
  left_join(price_dam |> select(hour, price_uah, volume), by = c("hour" = "hour")) |> 
  rename(
    price_dam = price_uah,
    volume_dam = volume
  ) |>
    mutate(
      spread_up = price_up - price_dam,
      spread_down = price_dam - price_down
    ) 

data_h |>
  pivot_longer(
    cols = matches("_(up|down)$"),
    names_to = c(".value", "side"),
    names_pattern = "(.*)_(up|down)$"
  ) |>
  mutate(side = factor(side)) |>
  group_by(year = factor(year(hour)), hour = hour(hour), side) |>
  summarise(
    spread = median(spread, na.rm = TRUE),
    volume = median(volume, na.rm = TRUE),
    .groups = "drop"
  ) |>
  pivot_longer(
    cols = c(spread, volume),
    names_to = "type",
    values_to = "value"
  ) |>
  ggplot(aes(x = hour, y = value, color = year)) +
    geom_smooth(
      method = "gam",
      formula = y ~ s(x, bs = "cs"),
      se = FALSE
    ) +
    facet_grid(cols = vars(side), rows = vars(type), scales = "free_y") +
    labs(
      title = "Intraday Price Spreads vs Day-Ahead Market",
      x = "",
      y = "Spread (UAH/MWh)"
    ) +
    theme_minimal()

data_d <- data_h |> 
  group_by(date = as_date(hour)) |>
  summarise(
    spread_up = sum(pmax(spread_up, 0) * volume_up, na.rm = TRUE) / sum(volume_up, na.rm = TRUE),
    spread_down = sum(pmax(spread_down, 0) * volume_down, na.rm = TRUE) / sum(volume_down, na.rm = TRUE),
    spread_tot = spread_up + spread_down,
    volume_up = sum(volume_up, na.rm = TRUE) / 24,
    volume_down = sum(volume_down, na.rm = TRUE) / 24,
    volume_tot = volume_up + volume_down,
    .groups = "drop"
  ) |> 
  pivot_longer(
    cols = matches("_(up|down|tot)$"),
    names_to = c(".value", "type"),
    names_pattern = "(.*)_(up|down|tot)$"
  ) |> 
  mutate(type = factor(type))

ggplot(data_d, aes(x = date)) +
  geom_point(aes(y = spread, color = type), alpha = 0.1) +
  geom_smooth(aes(y = spread, color = type), se=FALSE) +
  facet_grid(col = vars(type)) +
  theme_minimal()


ggplot(data_d, aes(x = date)) +
  geom_point(aes(y = volume, color = type), alpha = 0.1) +
  geom_smooth(aes(y = volume, color = type), se=FALSE) +
  facet_grid(col = vars(type)) +
  theme_minimal()

```